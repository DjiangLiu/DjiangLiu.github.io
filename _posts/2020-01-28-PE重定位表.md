---
title: PE导出表
date: 2020-1-28
categories: 
- PE
tags: 
- 重定位表
---

# 程序的加载过程
1. exe程序运行的时候都有4G的虚拟空间，在编译程序的时候可以指定imagebase（link中），程序需要的内存（imagebase+sizeofimage）。
2. 加载DLL的时候再次读取imagebase+sizeofimage，在根据入口地址（OEP）进行执行。
3. 多个DLL会出现基址一样的问题，后面的DLL会修改加载基址
4. 为了提高搜索速度，模块之间要对齐，模块地址对齐为10000H 也就是64K

# 解析
1. 重定位表在数据目录的第6个结构
2. 通过IMAGE_DATA_DIRECTORY结构的VirtualAddress属性，找到第一个IMAGE_BASE_RELOCATION

    ```
    typedef struct _IMAGE_BASE_RELOCATION {
        DWORD   VirtualAddress;//4字节
        DWORD   SizeOfBlock;//4字节，代表当前这一块一共有多大
        //  WORD    TypeOffset[1];
    } IMAGE_BASE_RELOCATION;
    typedef IMAGE_BASE_RELOCATION UNALIGNED * PIMAGE_BASE_RELOCATION;
    //具体项的值宽度为2字节
    ```
3. 当VirtualAddress和SizeOfBlock为0时导出表结束


# 作业：
1. 输出所有重定位表
2. 为什么这么设计