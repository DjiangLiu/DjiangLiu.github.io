---
title: C语言裸函数
date: 2019-11-19
categories: 
- C
tags: 
- C语言裸函数
- 反汇编
---

裸函数
	反汇编
```
	void __declspec(naked) Plus()
	{
		__asm
		{
			ret
		}
	}

	void main() {
		int a = 1, b = 2;
		int z = 0, x = 0;
		Plus();
	}
```
空函数
	反汇编


调用约定
	调用约定	压栈顺序	堆栈平衡谁来做
	```__cdecl```		从右至左	谁调用谁来平衡	c/c++默认
	```__stdcall```	从右至左	内平衡
	```__fastcall```	左边第二个放在edx中，左边第一个放在ecx，	内平衡
	

数据类型的三个要素
	1.存储数据的宽度
	2.存储数据的格式
	3.作用范围（作用域）

函数内部声明的局部变量

有符号和无符号 在类型转换和比较大小时一定要主要
	在内存中存储的时候都是一样的，只有在使用的时候要注意说明
	

整数
	1.char	8bit	1字节	byte
	2.short	16bit	2字节	word
	3.int	32bit	4字节	dword
	4.long	32bit	4字节
浮点型
	由三部分组成
	1.float
		
	2.double
		
		
浮点数将特定长度的连续字节（4字节/8字节）的所有二进制位（32位/64位）分隔为特定的三个域
	符号域：S，1位，整数为0，负数为1
	介码域：E，8位或11位。E = e+127 or E = e + 1023 因为指数e有正负之分，但介码为正。所以加127,1023偏移
	尾数位：M，23位或52位
	S（31） + 	E（8）	+	M（23）
	S（63）	+	E（11）	+	M（52）
	浮点数V的值
		V = (-1)^S*M*2^E = (-1)^S*2^(e+127)/(e+1023)
	7.25单精度、双精度的二进制
	7.25 = 所以S = 0	E
	7.25对应的二进制 111.01	1.1101*10^2
		符号位	0
		介码	2+127 = 129 2+1023 = 1029  129 1029是十进制 需要转为二进制
		尾数部分：1101	（单精度23位补19个0，双精度48个0）
		
		129 = 10000001
		0	10000001	1101	0000000000000000000
		0	10000000001	1101	000000000000000000000000000000000000000000000000
		0.25 == 0.01
		1 * 10^-2
		0	01111101	0000000000000000000000


C作用域
	


## 练习
	### 1.用__declspec(naked)裸函数实现下面功能
		int plus(int x,int y,int z)
		{
			int a = 2;
			int b = 3;
			int c = 4;
			return z + y + z + a + b + c;
		}
	### 2.将float 12.5转化为16进制
			```12.5 == 1100.1 == 1.1001*2^3```
			符号：0
			介码：```3+127 == 10000010```
			小数：```1001 0000 0000 0000 0000 000```
			所以：```0100 0001 0100 1000 0000 0000 0000 0000```
				81480000
	### 3.将一个exe还原成c语言
	
	### 4.有一个字符串是：china中国verygood天朝nice，编写一个函数，能截取任意长度的字符串n(n<=总长度)
		f(3) = china
		f(6) = china中
	
	
```
void __declspec(naked) Plus(int x,int y)
{
	__asm
	{
		//参数
		//局部变量，ebp-4
		//返回值，eax或者内存中

		//保留调用前的栈地
		push ebp
		//提升堆栈
		mov ebp,esp
		sub esp,0x40
		//保留现场
		push ebx
		push esi
		push edi
		//开始填充缓冲区
		mov eax,0xcccccccc
		mov ecx,0x10
		lea edi,dword ptr ds:[ebp-0x40]
		rep stosd

		//函数的和兴功能
		mov eax,dword ptr ds:[ebp+0x8]
		add eax,dword ptr ds:[ebp+0xc]

		//恢复现场
		pop edi
		pop esi
		pop ebx

		//降低堆栈
		mov esp,ebp
		pop ebp

		ret
	}
}

void main() {
	Plus(1, 2);
}
```