---
title: win32-线程-练习
date: 2020-3-15
categories: 
- win32
- 进程
tags: 
- 创建进程
- 句柄表
---

# 进程
## 进程创建过程
1. 程序（硬盘里的一堆数据PE格式）、镜像（拉伸后的）、进程

### 创建过程
1. 打开系统 - 双击程序 - 执行
2. 系统启动后首先创建一个进程 Explorer.exe（桌面进程）。
3. 也就是说一般的进程都是桌面进程的子进程。
4. 当用户双击程序，Explorer使用CreateProcess()函数创建一个exe。
5. 通过XueTr.exe，可以查看哪些进程是由Explorer创建的。

### CreateProcess()函数

```c
BOOL CreateProcess(
  LPCWSTR pszImageName,
  LPCWSTR pszCmdLine,
  LPSECURITY_ATTRIBUTES psaProcess,
  LPSECURITY_ATTRIBUTES psaThread,
  BOOL fInheritHandles,
  DWORD fdwCreate,
  LPVOID pvEnvironment,
  LPWSTR pszCurDir,
  LPSTARTUPINFOW psiStartInfo,
  LPPROCESS_INFORMATION pProcInfo
);
```
1. 首先在内核中创建一个句柄。NtCreateProcess,在高2G创建一个句柄表，初始为空。进程是一个空间的概念。而线程则是真正的执行代码。
2. 当使用其他的内核对象的时候，句柄表保存每个句柄和相应地址的对应关系。
3. 在分配4G的虚拟空间
   - 0-ffff NULL指针使用
   - 0x00010000-0x7FFFFFFF 用户区，将EXE懒神，存储到指定的位置
     - 遍历exe导入表，将需要用的DLL拉伸到指定的位置，如果位置被占用，则通过重定位表，则换地址并修复相应地址
     - DLL如果引用其他地址，则循环上一步。
     - 修复EXE/DLL的IAT表，将函数的地址复制到IAT表内。
     - 创建线程、设置线程CONTEXT开始执行。
   - 0x80000000 - 0xFFFFFFFF 内核空间。

## 创建进程
## 进程终止
## 句柄继承