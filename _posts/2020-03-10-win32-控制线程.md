title: win32-创建线程
date: 2020-3-10
categories: 
- win32
- 线程
tags: 
- 控制线程
- 线程上下文
- 线程和全局变量
---

# 终止线程
1. ExitThread(DWORD ) 在线程中使用，比如线程到某个条件则结束。释放掉当前线程的所有堆栈，不会做任何多余操作，包括析构函数
2. 线程函数返回。定义一个全局变量，当达到某种条件的时候进行退出，并释放掉一些资源。
3. `TerminateThread(hThread,2);WaitForSingLeObject(hThread,INFINITE);`,TerminateThread参数一是句柄，参数二是退出码。和ExitThread 同步 TerminateThread是异步的。但是堆栈没用清理，所以其他的线程或函数依然可以使用这些值。

```c
hThread: 线程句柄
dwExitCode:线程结束码。可以通过GetExitCodeThread来获取一个线程的退出码。
```

```c
同步执行，一定是exit执行完成之后才会执行下面的代码
ExitThread(2);
//代码
```

```c
异步执行，可能存在TerminateThread另起一个线程还没执行完就执行下面的代码。所以需要用一个阻塞的代码WaitForSingLeObject
TerminateThread(hThread,3);
WaitForSingLeObject()
//代码
```

# 线程context
1. *进程就是4GB，线程就是EIP。*
每个线程在执行的时候，都会独自占用一个CPU，当系统线程数大于CPU数量时，就会存在多个线程共用一个CPU的情况。

```c
Dr0-Dr7寄存器
ESP EBP等寄存器
```