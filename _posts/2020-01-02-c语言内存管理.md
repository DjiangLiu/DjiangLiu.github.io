---
title: C语言内存管理
date: 2020-1-2
categories: 
- C
- 内存管理
tags: 
- 内存管理
---

# 系统虚拟空间分布
- 0x00000000-0x7ffffff 其中最开始有64KB的NULL空间（0x00000000-0x0000ffff）
- 可以通过PAE技术扩展到64位（win一般是44位16TB、lin 48位）

# 程序内存布局
1. 堆
2. 栈（从高地址到低地址）
3. 静态区
4. 代码区

## 堆和栈的区别
### 内存分配
1. 栈：有系统自动分配与回收，int b = 0;增长由高到低
2. 堆：malloc、free 地址由低到高
### 大小限制
1. 栈：应用层1M-10M，内核层12K-24K
2. 堆：受限于计算机系统有效的虚拟内存
### 效率比较
1. 栈：系统自动分配，速度快，但程序员无法控制
2. 堆：速度较慢，而且容易产生碎片
### 存放内容
1. 栈：用来记录程序执行时函数调用过程中的活动记录（栈针），参数、返回地址、ebp、局部变量
2. 堆：一般在堆的头部用一个字节存放堆的大小，剩余部分存储的内容由程序员根据成计算的需要决定

## 内存地址分类
1. 逻辑地址

    由编译器生成，使用c语言指针时，指针的值就是逻辑地址。对于每一个进程而言，他们都有一样的进程空间，类似的逻辑地址，甚至可能相同。逻辑地址由段地址+段内偏移组成

2. 线性地址

    由分段基址将逻辑地址转化而来，如果没有分段机制作用，逻辑地址就是线性地址

3. 物理地址

    CPU在存取数据是最终在地址总线上发出的电平信号，靠该地址来访问对应数据。要得到物理地址，必须将逻辑地址经过分段、分页等机制转化而来
## 寻址模式
从逻辑地址到物理地址的过程就是寻址，X86系统中两种模式：
1. 分段模型

    在16位系统中，地址总线占20位支持**2^20=1M**的寻址空间，16系统却只能表示**2^16=64K**，所以进行分段。`16*2^16==16*64`,对于不同的程序有不同的CS、DS值，每个程序的段起始地址都不同。Seg<<4+Offset

2. 扁平模型

    当CPU运行32为模式时，寄存器和指令都可以寻址整个线性地址空间，所以不需要调整CS、DS，基址可以设为唯一一个统一的值，linux、winXP/7采用的寻址模式。段主要分为四种：内核代码段、内核数据段、用户代码段、用户数据段。对于内核代码段和内核数据段而言CS、DS值：0xc0000000；对于用户代码段和用户数据段CS、DS：0x00000000
3. 实模式

    实模式运行在20位地址总线，寻址空间为1M。但寄存器是16位，因为段被分为64KB固定大小，1M空间被分成16个不同的段，CS、DS等存储的段的起始地址，通过CS<<4+IP进行寻址
4. 保护模式

    32位地址总线，地址使用虚拟地址，引入页表和段描述符表，用GDT和LDT段描述符的数据结构来定义每个段，通过页表进行寻址