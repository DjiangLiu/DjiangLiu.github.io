---
title: win32-加密壳
date: 2020-3-17
categories: 
- win32
- 加密壳
tags: 
- 加密壳
---

# 加密壳
## 二进制壳
1. 并不改变指令含义，只是对特定代码进行加密。
2. 在执行的时候，在内存中展开的一定是原先的模样。
3. 找到程序的入口点，然后dump出来，就可以实现脱壳了。

## 指令壳


## 加壳程序的编写
### 加密方法
1. 获取shell程序路径。
2. 获取Src程序路径。
3. 将src程序读到内存中，并加密。
4. 在shell程序中新增一个节，并将加密后的src程序追加到shell程序的新增节中。
5. 加壳过程完毕。
6. 壳程序本身就是用来解密的。

### 解密方法
1. 读取壳子模块数据。
2. 解密：得到原来的PE文件
3. 在壳程序跑起来内，已挂起的方式创建进程：CreateProcess。要创建的进程就是壳子本身。

### 注意
1. 在程序真正执行前一点要正确的解密所有代码。
2. 追加代码，并转到真正的OEP。
3. 在解密的代码中，如果使用到API，而系统没有加载。所以解密的函数，都需要自己实现。如果使用静态文件在编译的时候就已经确定了，所以要使用ShellCode。
4. 获取外壳程序的context。
5. 卸载外壳程序的镜像文件。（ZwUnmapViewOfSection）
6. 在指定的位置分配空间：位置就是Src的ImageBase，空间是SizeOfImage（VitrualAllocEx）
7. 如果成功，将Src文件拉伸，并复制到该空间中。
8. 如果申请空间失败，且该Src程序是有重定位表，在任意位置申请空间，然后将PE文件拉伸、复制、修复重定位表。否则放回失败。
9. 修改外壳程序的Context的ImageBase，修改成Src的ImageBase；将Context的OEP修改成Src的OEP。
10. 设置Context，并恢复主线程。
11. 终止外壳程序（最开始的壳，不是CreateProcess），解壳成功。



## 