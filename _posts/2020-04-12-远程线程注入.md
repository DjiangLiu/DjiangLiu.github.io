---
title: 远程线程注入
date: 2020-4-12
categories: 
- 远程线程注入
tags: 
- ShellCode
- 远程线程注入
---


# 远程线程注入
## 进程就是4GB空间
## 代码的执行需要线程的支持
## 两种方案
### 方案1：HOOK
1. 在原有的线程执行过程中，调到新增的代码处。
2. 然后再调回原来的地址。

### 方案2：新创建一个线程
1. 直接新创建一个线程用来执行代码。

# 注入代码
## 注入一个模块
### 优点
1. 方便（包含了全局变量、IAT表）

### 缺点
1. 特征比较明显。

## 注入一个函数
### 优点
1. 很难被检测到。

### 缺点
1. 直接贴代码会存在硬编码以及全局变量地址的问题。
2. 如果调用模块中的函数，需要知道模块加载过来之后的地址FF 还是 E8。即IAT表的问题。

# DLL注入
## 在B进程中创建远程线程，并且lpStartAddress为LoadLibrary函数
1. CreateRemoteThread()

## 创建远程线程是需要指定进程ID/线程函数/线程函数的参数
1. PID的获取
2. 线程函数的地址
   1. LoadLibrary的地址
3. VirtualAllocEx分配空间，用来存放线程函数的参数

## 等待线程结束，通过LoadLibrary的返回值，即DLL的首地址
1. waitforsingleobject
2. getexitcodethread

## 释放为DLL申请的空间
1. VirualFreeEx

## 关闭句柄
1. ClossHandle

## 如何启动A进程中执行的代码

# ShellCode
1. 本身就是一堆硬编码。
2. 不依赖全局变量，无论编写在哪里都可以运行。
3. 不要使用全局变量。
4. 不要使用IAT表中的函数。